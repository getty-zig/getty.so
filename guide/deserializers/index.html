<!DOCTYPE html>
<!-- SPDX-License-Identifier: LGPL-2.1-or-later -->

<html>

  <!-- SPDX-License-Identifier: LGPL-2.1-or-later -->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0021D8">

  <title>Deserializers</title>

  <link rel="canonical" href="https://getty.so/guide/deserializers/">
  <link rel="alternate" type="application/rss+xml" title="Getty" href="https://getty.so/feed.xml" />

  <link rel="stylesheet" href="/style.css">
  
  <link rel="icon" type="image/png" href="/assets/images/favicon.png" />
</head>


  <body>

    <!-- SPDX-License-Identifier: LGPL-2.1-or-later -->

<header class="site-header">
  <div class="wrapper" style="text-align: center;">
    <a class="page-logo" href="/">
      <img src="/assets/images/page-logo.svg" alt="getty">
    </a>
  </div>
</header>


    <div class="container">
      <h1 id="deserializers">Deserializers</h1>

<p>Now letâ€™s write ourselves a (simple) JSON deserializer.</p>

<h2 id="deserialization">Deserialization</h2>

<p>Before we start though, we need to go over how deserialization works in Getty.</p>

<p><img alt="Architecture" src="/assets/images/deserialization.svg" class="figure" /></p>

<p>Basically, it goes like this:</p>

<ol>
  <li>A user passes a Zig type to Getty.</li>
  <li>Based on the type, Getty selects and executes a Deserialization Block (DB).</li>
  <li>The DB prompts a deserializer to deserialize its input data.</li>
  <li>The deserializer deserializes its input data into Gettyâ€™s Data Model.</li>
  <li>The resulting Getty value is then passed to a visitor.</li>
  <li>The visitor uses the Getty value to create a Zig value of the passed-in type.</li>
</ol>

<p>As an example, say we want to deserialize into a <code class="language-plaintext highlighter-rouge">std.ArrayList(i32)</code> from a JSON array:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">std.ArrayList(i32)</code> is passed to Getty.</li>
  <li>Getty selects and executes a DB for <em>Sequences</em>.</li>
  <li>The DB calls the <code class="language-plaintext highlighter-rouge">deserializeSeq</code> method on a deserializer.</li>
  <li>The deserializer parses an array from its input data and deserializes it into a <em>Sequence</em>.</li>
  <li>The deserializer passes the <em>Sequence</em> to a visitor (by calling <code class="language-plaintext highlighter-rouge">visitSeq</code> on the Visitor).</li>
  <li>The visitor uses the <em>Sequence</em> to create a <code class="language-plaintext highlighter-rouge">std.ArrayList(i32)</code> value.</li>
</ol>

<p>The important thing to understand here is that deserializers and visitors are different:</p>

<ul>
  <li>Deserializers deserialize from a data format into Gettyâ€™s Data Model.</li>
  <li>Visitors deserialize from Gettyâ€™s Data Model into Zig.</li>
</ul>

<p><br /></p>

<p><strong>Itâ€™s <em>very</em> important that you understand this difference!</strong> So be sure you got it down before moving on.</p>

<p><br /></p>

<h2 id="lets-write-a-deserializer">Letâ€™s Write a Deserializer!</h2>

<p>Every Getty deserializer must implement the <code class="language-plaintext highlighter-rouge">getty.Deserializer</code> interface, shown below.</p>

<div class="code-block"><div class="language-tag">Zig code</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="c">// getty.Deserializer specifies the behavior of a deserializer, and must be</span>
<span class="c">// implemented by all Getty deserializers.</span>
<span class="k">fn</span> <span class="n">Deserializer</span><span class="p">(</span>
    <span class="c">// Context is the namespace that owns the method implementations you want</span>
    <span class="c">// to use to implement getty.Deserializer.</span>
    <span class="c">//</span>
    <span class="c">// Usually, this is whatever type is implementing getty.Deserializer (or a</span>
    <span class="c">// pointer to it if mutability is required in your method implementations).</span>
    <span class="k">comptime</span> <span class="n">Context</span><span class="p">:</span> <span class="k">type</span><span class="p">,</span>

    <span class="c">// E is the error set returned by getty.Deserializer's required methods</span>
    <span class="c">// upon failure.</span>
    <span class="c">//</span>
    <span class="c">// A default error set, getty.de.Error, is provided by Getty. Every default</span>
    <span class="c">// Visitor within Getty uses the default error set, which means that 9 times</span>
    <span class="c">// out of 10, you will want to include getty.de.Error for this parameter.</span>
    <span class="k">comptime</span> <span class="n">E</span><span class="p">:</span> <span class="k">type</span><span class="p">,</span>

    <span class="c">// user_dbt and de_dbt are user- and deserializer- defined Deserialization</span>
    <span class="c">// Blocks or Tuples (DBT), respectively.</span>
    <span class="c">//</span>
    <span class="c">// DBTs define Getty's deserialization behavior. If user- or deserializer-</span>
    <span class="c">// defined customization is not supported or needed by your deserializer,</span>
    <span class="c">// you can pass in null for these parameters.</span>
    <span class="c">//</span>
    <span class="c">// You can ignore these parameters for now. We'll come back to them later.</span>
    <span class="k">comptime</span> <span class="n">user_dbt</span><span class="p">:</span> <span class="n">anytype</span><span class="p">,</span>
    <span class="k">comptime</span> <span class="n">ser_dbt</span><span class="p">:</span> <span class="n">anytype</span><span class="p">,</span>

    <span class="c">// methods contains every method that getty.Deserializer implementations can</span>
    <span class="c">// implement.</span>
    <span class="c">//</span>
    <span class="c">// In this tutorial, we'll be providing implementations for most of</span>
    <span class="c">// these methods. However, if you don't want to implement a specific</span>
    <span class="c">// method, you can simply omit its corresponding field.</span>
    <span class="k">comptime</span> <span class="n">methods</span><span class="p">:</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="n">deserializeBool</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeEnum</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeFloat</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeIgnored</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeInt</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeMap</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeOptional</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeSeq</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeString</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeStruct</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeUnion</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="n">deserializeVoid</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="k">type</span></code></pre></figure>

</pre></div>

<p>Similar to <code class="language-plaintext highlighter-rouge">getty.Serializer</code>, most of <code class="language-plaintext highlighter-rouge">getty.Deserializer</code>â€™s parameters have default values that we can use. So letâ€™s start with the following <code class="language-plaintext highlighter-rouge">getty.Deserializer</code> implementation:</p>

<div class="code-block"><div class="language-tag">src/main.zig</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">const</span> <span class="n">std</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"std"</span><span class="p">);</span>
<span class="k">const</span> <span class="n">getty</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"getty"</span><span class="p">);</span>

<span class="k">const</span> <span class="n">Deserializer</span> <span class="o">=</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">,</span> <span class="c">// ðŸ‘‹ A JSON parser provided by the standard library.</span>

    <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="nb">@This</span><span class="p">();</span>

    <span class="k">pub</span> <span class="k">usingnamespace</span> <span class="n">getty</span><span class="p">.</span><span class="nf">Deserializer</span><span class="p">(</span>
        <span class="o">*</span><span class="n">Self</span><span class="p">,</span>
        <span class="n">Error</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="o">.</span><span class="p">{},</span>
    <span class="p">);</span>

    <span class="k">const</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseIntError</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseFloatError</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">De</span> <span class="o">=</span> <span class="n">Self</span><span class="o">.@</span><span class="s">"getty.Deserializer"</span><span class="p">;</span> <span class="c">// ðŸ‘‹ Alias for our interface type.</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="n">init</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="p">[]</span><span class="k">const</span> <span class="kt">u8</span><span class="p">)</span> <span class="n">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="p">{</span> <span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">};</span></code></pre></figure>

</pre></div>

<p>Congratulations! Youâ€™ve just written your first Getty deserializer!</p>

<p>Letâ€™s try deserializing some JSON data with it by calling <code class="language-plaintext highlighter-rouge">getty.deserialize</code>, which takes an optional allocator, a type to deserialize into, and a <code class="language-plaintext highlighter-rouge">getty.Deserializer</code> interface value.</p>

<div class="code-block"><div class="language-tag">src/main.zig</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">const</span> <span class="n">std</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"std"</span><span class="p">);</span>
<span class="k">const</span> <span class="n">getty</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"getty"</span><span class="p">);</span>

<span class="k">const</span> <span class="n">Deserializer</span> <span class="o">=</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">,</span>

    <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="nb">@This</span><span class="p">();</span>

    <span class="k">pub</span> <span class="k">usingnamespace</span> <span class="n">getty</span><span class="p">.</span><span class="nf">Deserializer</span><span class="p">(</span>
        <span class="o">*</span><span class="n">Self</span><span class="p">,</span>
        <span class="n">Error</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="o">.</span><span class="p">{},</span>
    <span class="p">);</span>

    <span class="k">const</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseIntError</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseFloatError</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">De</span> <span class="o">=</span> <span class="n">Self</span><span class="o">.@</span><span class="s">"getty.Deserializer"</span><span class="p">;</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="n">init</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="p">[]</span><span class="k">const</span> <span class="kt">u8</span><span class="p">)</span> <span class="n">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="p">{</span> <span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c">// ðŸ‘‡</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="k">anyerror</span><span class="o">!</span><span class="k">void</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"true"</span><span class="p">;</span>

    <span class="k">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Deserializer</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">();</span>

    <span class="k">const</span> <span class="n">v</span> <span class="o">=</span> <span class="k">try</span> <span class="n">getty</span><span class="p">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">bool</span><span class="p">,</span> <span class="n">deserializer</span><span class="p">);</span>

    <span class="n">std</span><span class="p">.</span><span class="py">debug</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"{} ({})</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">.</span><span class="p">{</span> <span class="n">v</span><span class="p">,</span> <span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

</pre></div>

<div class="code-block"><div class="language-tag">Shell session</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>zig build run
<span class="go">[...] error:  deserializeBool is not implemented by type: *main.Deserializer</span></code></pre></figure>

</pre></div>

<p>Oh no, a compile error!</p>

<p>Looks like Getty canâ€™t deserialize into the <code class="language-plaintext highlighter-rouge">bool</code> type for us unless the <code class="language-plaintext highlighter-rouge">deserializeBool</code> method has been implemented. So, letâ€™s go ahead and do that.</p>

<div class="code-block"><div class="language-tag">src/main.zig</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">const</span> <span class="n">std</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"std"</span><span class="p">);</span>
<span class="k">const</span> <span class="n">getty</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"getty"</span><span class="p">);</span>

<span class="c">// ðŸ‘‡</span>
<span class="k">const</span> <span class="n">Allocator</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">;</span>

<span class="k">const</span> <span class="n">Deserializer</span> <span class="o">=</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">,</span>

    <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="nb">@This</span><span class="p">();</span>

    <span class="k">pub</span> <span class="k">usingnamespace</span> <span class="n">getty</span><span class="p">.</span><span class="nf">Deserializer</span><span class="p">(</span>
        <span class="o">*</span><span class="n">Self</span><span class="p">,</span>
        <span class="n">Error</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="o">.</span><span class="p">{</span>
            <span class="p">.</span><span class="py">deserializeBool</span> <span class="o">=</span> <span class="n">deserializeBool</span><span class="p">,</span> <span class="c">// ðŸ‘ˆ</span>
        <span class="p">},</span>
    <span class="p">);</span>

    <span class="k">const</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseIntError</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseFloatError</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">De</span> <span class="o">=</span> <span class="n">Self</span><span class="o">.@</span><span class="s">"getty.Deserializer"</span><span class="p">;</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="n">init</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="p">[]</span><span class="k">const</span> <span class="kt">u8</span><span class="p">)</span> <span class="n">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="p">{</span> <span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeBool</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="c">// ðŸ‘‹ Here's what we're doing:</span>
        <span class="c">//</span>
        <span class="c">//      1. Parse a token from the JSON data.</span>
        <span class="c">//      2. Check to see if the token is a JSON Boolean.</span>
        <span class="c">//      3. Deserialize the token into a Getty Boolean (token == .True).</span>
        <span class="c">//      4. Pass the Getty Boolean to the visitor, v.</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span> <span class="k">or</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">False</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitBool</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="k">anyerror</span><span class="o">!</span><span class="k">void</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"true"</span><span class="p">;</span>

    <span class="k">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Deserializer</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">();</span>

    <span class="k">const</span> <span class="n">v</span> <span class="o">=</span> <span class="k">try</span> <span class="n">getty</span><span class="p">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">bool</span><span class="p">,</span> <span class="n">deserializer</span><span class="p">);</span>

    <span class="n">std</span><span class="p">.</span><span class="py">debug</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"{} ({})</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">.</span><span class="p">{</span> <span class="n">v</span><span class="p">,</span> <span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

</pre></div>

<div class="code-block"><div class="language-tag">Shell session</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>zig build run
<span class="go">true (bool)</span></code></pre></figure>

</pre></div>

<p>Success!</p>

<!--With that in mind, let's talk about deserializeBool. This method serves-->
<!--as a *hint* to our deserializer that the Visitor v will (most likely)-->
<!--produce a Boolean value.-->

<!--Using this hint, our deserializeBool implementation will try to parse-->
<!--a Boolean from the deserializer's input. After all, if the visitor is-->
<!--trying to make a Boolean value, it doesn't make sense to parse a float-->
<!--or string.-->

<p>Now letâ€™s do the same thing for <code class="language-plaintext highlighter-rouge">deserializeEnum</code>, <code class="language-plaintext highlighter-rouge">deserializeFloat</code>, <code class="language-plaintext highlighter-rouge">deserializeInt</code>, <code class="language-plaintext highlighter-rouge">deserializeOptional</code>, <code class="language-plaintext highlighter-rouge">deserializeString</code>, and <code class="language-plaintext highlighter-rouge">deserializeVoid</code>.</p>

<div class="code-block"><div class="language-tag">src/main.zig</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">const</span> <span class="n">std</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"std"</span><span class="p">);</span>
<span class="k">const</span> <span class="n">getty</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"getty"</span><span class="p">);</span>

<span class="k">const</span> <span class="n">Allocator</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">;</span>

<span class="k">const</span> <span class="n">Deserializer</span> <span class="o">=</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">,</span>

    <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="nb">@This</span><span class="p">();</span>

    <span class="k">pub</span> <span class="k">usingnamespace</span> <span class="n">getty</span><span class="p">.</span><span class="nf">Deserializer</span><span class="p">(</span>
        <span class="o">*</span><span class="n">Self</span><span class="p">,</span>
        <span class="n">Error</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="o">.</span><span class="p">{</span>
            <span class="p">.</span><span class="py">deserializeBool</span> <span class="o">=</span> <span class="n">deserializeBool</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeEnum</span> <span class="o">=</span> <span class="n">deserializeEnum</span><span class="p">,</span>         <span class="c">// ðŸ‘ˆ</span>
            <span class="p">.</span><span class="py">deserializeFloat</span> <span class="o">=</span> <span class="n">deserializeFloat</span><span class="p">,</span>       <span class="c">// ðŸ‘ˆ</span>
            <span class="p">.</span><span class="py">deserializeInt</span> <span class="o">=</span> <span class="n">deserializeInt</span><span class="p">,</span>           <span class="c">// ðŸ‘ˆ</span>
            <span class="p">.</span><span class="py">deserializeString</span> <span class="o">=</span> <span class="n">deserializeString</span><span class="p">,</span>     <span class="c">// ðŸ‘ˆ</span>
            <span class="p">.</span><span class="py">deserializeVoid</span> <span class="o">=</span> <span class="n">deserializeVoid</span><span class="p">,</span>         <span class="c">// ðŸ‘ˆ</span>
            <span class="p">.</span><span class="py">deserializeOptional</span> <span class="o">=</span> <span class="n">deserializeOptional</span><span class="p">,</span> <span class="c">// ðŸ‘ˆ</span>
        <span class="p">},</span>
    <span class="p">);</span>

    <span class="k">const</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseIntError</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseFloatError</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">De</span> <span class="o">=</span> <span class="n">Self</span><span class="o">.@</span><span class="s">"getty.Deserializer"</span><span class="p">;</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="n">init</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="p">[]</span><span class="k">const</span> <span class="kt">u8</span><span class="p">)</span> <span class="n">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="p">{</span> <span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeBool</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span> <span class="k">or</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">False</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitBool</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeEnum</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="c">// ðŸ‘‹ Again, all we're doing is parsing tokens, turning them</span>
        <span class="c">//    into Getty values, and passing those values to a visitor.</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">String</span><span class="p">)</span> <span class="p">{</span>
                <span class="c">// ðŸ‘‹ By the way, you'll see token.X.slice pretty often in our</span>
                <span class="c">//    deserializer. All it's doing is getting the string that</span>
                <span class="c">//    corresponds to our token from the JSON data.</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">String</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitString</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeFloat</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Number</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitFloat</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseFloat</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span> <span class="n">str</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeInt</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Number</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="py">is_integer</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">try</span> <span class="k">switch</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                        <span class="sc">'-'</span> <span class="o">=&gt;</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitInt</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseInt</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                        <span class="k">else</span> <span class="o">=&gt;</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitInt</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseInt</span><span class="p">(</span><span class="kt">u64</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeString</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">String</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">String</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitString</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">allocator</span><span class="o">.?</span><span class="p">.</span><span class="nf">dupe</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span> <span class="n">str</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeVoid</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitVoid</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeOptional</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="c">// ðŸ‘‹ deserializeOptional is a bit different from the other methods.</span>
        <span class="c">//    Instead of passing a Getty value to a visitor, you pass a</span>
        <span class="c">//    deserializer to visitSome. The visitor will then restart the</span>
        <span class="c">//    deserialization process using the optional's payload.</span>
        <span class="c">//</span>
        <span class="c">//    In other words, you can think of this method as a place to do</span>
        <span class="c">//    some pre-processing before deserializing an actual payload value.</span>
        <span class="k">const</span> <span class="n">backup</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitNull</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">self</span><span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">backup</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitSome</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="k">anyerror</span><span class="o">!</span><span class="k">void</span> <span class="p">{</span>
    <span class="c">// ðŸ‘‡</span>
    <span class="k">const</span> <span class="n">allocator</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">heap</span><span class="p">.</span><span class="py">page_allocator</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">types</span> <span class="o">=</span> <span class="o">.</span><span class="p">{</span> <span class="kt">i32</span><span class="p">,</span> <span class="kt">f32</span><span class="p">,</span> <span class="p">[]</span><span class="kt">u8</span><span class="p">,</span> <span class="k">enum</span> <span class="p">{</span> <span class="n">foo</span> <span class="p">},</span> <span class="o">?</span><span class="kt">u8</span><span class="p">,</span> <span class="k">void</span> <span class="p">};</span>
    <span class="k">const</span> <span class="n">jsons</span> <span class="o">=</span> <span class="o">.</span><span class="p">{</span> <span class="s">"10"</span><span class="p">,</span> <span class="s">"10.0"</span><span class="p">,</span> <span class="s">"</span><span class="se">\"</span><span class="s">ABC</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="s">"</span><span class="se">\"</span><span class="s">foo</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="s">"null"</span><span class="p">,</span> <span class="s">"null"</span> <span class="p">};</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">inline</span> <span class="k">for</span> <span class="p">(</span><span class="n">jsons</span><span class="p">)</span> <span class="p">|</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">|</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">T</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="k">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Deserializer</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="k">const</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">();</span>

        <span class="k">const</span> <span class="n">v</span> <span class="o">=</span> <span class="k">try</span> <span class="n">getty</span><span class="p">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">deserializer</span><span class="p">);</span>
        <span class="k">defer</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

        <span class="n">std</span><span class="p">.</span><span class="py">debug</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"{any} ({})</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">.</span><span class="p">{</span> <span class="n">v</span><span class="p">,</span> <span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

</pre></div>

<div class="code-block"><div class="language-tag">Shell session</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>zig build run
<span class="go">10 (i32)
1.0e+01 (f32)
{ 65, 66, 67 } ([]u8)
main.main__enum_1317.foo (main.main__enum_1317)
null (?u8)
void (void)</span></code></pre></figure>

</pre></div>

<p>Not too shabby! ðŸ¤©</p>

<p>At this point, the only methods left to implement are those related to aggregate deserialization. However, before we move on, I want to point out something important about <code class="language-plaintext highlighter-rouge">Deserializer</code>.</p>

<p>When Getty calls the <code class="language-plaintext highlighter-rouge">deserializeBool</code> method we implemented earlier, it is <em>not</em> telling <code class="language-plaintext highlighter-rouge">Deserializer</code> that it should parse and deserialize a JSON Boolean from its input data. Instead, <strong>Getty is simply providing a <em>hint</em> about the type that is being deserialized into</strong>. That is, Getty is telling <code class="language-plaintext highlighter-rouge">Deserializer</code>, â€œ<em>Hey, the type that the user is deserializing into can probably be made from a Getty Boolean.</em>â€</p>

<p>What this means is that we donâ€™t have to limit ourselves to parsing only JSON Booleans in <code class="language-plaintext highlighter-rouge">deserializeBool</code>. We could, for instance, have it support JSON numbers as well!</p>

<div class="code-block"><div class="language-tag">Zig code</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">fn</span> <span class="n">deserializeBool</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
        <span class="c">// JSON Booleans -&gt; Getty Booleans</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span> <span class="k">or</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">False</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitBool</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c">// JSON Numbers -&gt; Getty Booleans</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Number</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="py">is_integer</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitBool</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseInt</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

</pre></div>

<h2 id="aggregate-deserialization">Aggregate Deserialization</h2>

<p>Alright, letâ€™s move on to deserialization for aggregate types!</p>

<p>The only difference between scalar and aggregate deserialization is that the aggregate types within Gettyâ€™s data model do not have any direct mapping to Zig types. That is, a Getty Boolean is just a <code class="language-plaintext highlighter-rouge">bool</code> and a Getty Integer is just any Zig integer type, but whatâ€™s a Getty Sequence or a Getty Map?</p>

<p>Well, this is where the aggregate deserialization interfaces come in. There are three of them: <code class="language-plaintext highlighter-rouge">getty.de.SeqAccess</code>, <code class="language-plaintext highlighter-rouge">getty.de.MapAccess</code>, and <code class="language-plaintext highlighter-rouge">getty.de.UnionAccess</code>. Weâ€™ll
start by implementing <code class="language-plaintext highlighter-rouge">deserializeSeq</code>, which will obviously use the <code class="language-plaintext highlighter-rouge">getty.de.SeqAccess</code> interface.</p>

<div class="code-block"><div class="language-tag">Zig code</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">fn</span> <span class="n">SeqAccess</span><span class="p">(</span>
    <span class="k">comptime</span> <span class="n">Context</span><span class="p">:</span> <span class="k">type</span><span class="p">,</span>
    <span class="k">comptime</span> <span class="n">E</span><span class="p">:</span> <span class="k">type</span><span class="p">,</span>
    <span class="k">comptime</span> <span class="n">methods</span><span class="p">:</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="n">nextElementSeed</span><span class="p">:</span> <span class="o">?</span><span class="k">fn</span> <span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">E</span><span class="o">!?</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">seed</span><span class="p">).</span><span class="py">Value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="k">type</span></code></pre></figure>

</pre></div>

<div class="code-block"><div class="language-tag">src/main.zig</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-zig" data-lang="zig"><span class="k">const</span> <span class="n">std</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"std"</span><span class="p">);</span>
<span class="k">const</span> <span class="n">getty</span> <span class="o">=</span> <span class="nb">@import</span><span class="p">(</span><span class="s">"getty"</span><span class="p">);</span>

<span class="k">const</span> <span class="n">Allocator</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">mem</span><span class="p">.</span><span class="py">Allocator</span><span class="p">;</span>

<span class="k">const</span> <span class="n">Deserializer</span> <span class="o">=</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">tokens</span><span class="p">:</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">,</span>

    <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="nb">@This</span><span class="p">();</span>

    <span class="k">pub</span> <span class="k">usingnamespace</span> <span class="n">getty</span><span class="p">.</span><span class="nf">Deserializer</span><span class="p">(</span>
        <span class="o">*</span><span class="n">Self</span><span class="p">,</span>
        <span class="n">Error</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="kc">null</span><span class="p">,</span>
        <span class="o">.</span><span class="p">{</span>
            <span class="p">.</span><span class="py">deserializeBool</span> <span class="o">=</span> <span class="n">deserializeBool</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeEnum</span> <span class="o">=</span> <span class="n">deserializeEnum</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeFloat</span> <span class="o">=</span> <span class="n">deserializeFloat</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeInt</span> <span class="o">=</span> <span class="n">deserializeInt</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeString</span> <span class="o">=</span> <span class="n">deserializeString</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeVoid</span> <span class="o">=</span> <span class="n">deserializeVoid</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeOptional</span> <span class="o">=</span> <span class="n">deserializeOptional</span><span class="p">,</span>
            <span class="p">.</span><span class="py">deserializeSeq</span> <span class="o">=</span> <span class="n">deserializeSeq</span><span class="p">,</span> <span class="c">// ðŸ‘ˆ</span>
        <span class="p">},</span>
    <span class="p">);</span>

    <span class="k">const</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="py">Error</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseIntError</span> <span class="p">||</span>
        <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="py">ParseFloatError</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">De</span> <span class="o">=</span> <span class="n">Self</span><span class="o">.@</span><span class="s">"getty.Deserializer"</span><span class="p">;</span>

    <span class="k">pub</span> <span class="k">fn</span> <span class="n">init</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="p">[]</span><span class="k">const</span> <span class="kt">u8</span><span class="p">)</span> <span class="n">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">.</span><span class="p">{</span> <span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">json</span><span class="p">.</span><span class="py">TokenStream</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeBool</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span> <span class="k">or</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">False</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitBool</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">True</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeEnum</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">String</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">String</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitString</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeFloat</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Number</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitFloat</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseFloat</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span> <span class="n">str</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeInt</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Number</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="py">Number</span><span class="p">.</span><span class="py">is_integer</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">try</span> <span class="k">switch</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                        <span class="sc">'-'</span> <span class="o">=&gt;</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitInt</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseInt</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                        <span class="k">else</span> <span class="o">=&gt;</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitInt</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">std</span><span class="p">.</span><span class="py">fmt</span><span class="p">.</span><span class="nf">parseInt</span><span class="p">(</span><span class="kt">u64</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                    <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeString</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">String</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="py">String</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitString</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="k">try</span> <span class="n">allocator</span><span class="o">.?</span><span class="p">.</span><span class="nf">dupe</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span> <span class="n">str</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeVoid</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitVoid</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="n">deserializeOptional</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">backup</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">Null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitNull</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">self</span><span class="p">.</span><span class="py">tokens</span> <span class="o">=</span> <span class="n">backup</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitSome</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">fn</span> <span class="n">deserializeSeq</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="n">Self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Error</span><span class="o">!</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">try</span> <span class="n">self</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="nf">next</span><span class="p">())</span> <span class="p">|</span><span class="n">token</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="p">.</span><span class="py">ArrayBegin</span><span class="p">)</span> <span class="p">{</span>
                <span class="c">// ðŸ‘‹ Note that we pass in the interface value of SeqAccess to</span>
                <span class="c">//    the visitor, and not the implementation itself.</span>
                <span class="k">var</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">SeqAccess</span><span class="p">{</span> <span class="p">.</span><span class="py">de</span> <span class="o">=</span> <span class="n">self</span> <span class="p">};</span>
                <span class="k">return</span> <span class="k">try</span> <span class="n">v</span><span class="p">.</span><span class="nf">visitSeq</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">sa</span><span class="p">.</span><span class="nf">seqAccess</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">error</span><span class="p">.</span><span class="py">InvalidType</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c">// ðŸ‘‡</span>
<span class="k">const</span> <span class="n">SeqAccess</span> <span class="o">=</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">de</span><span class="p">:</span> <span class="o">*</span><span class="n">Deserializer</span><span class="p">,</span>

    <span class="k">pub</span> <span class="k">usingnamespace</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="nf">SeqAccess</span><span class="p">(</span>
        <span class="o">*</span><span class="nb">@This</span><span class="p">(),</span>
        <span class="n">Deserializer</span><span class="p">.</span><span class="py">Error</span><span class="p">,</span>
        <span class="o">.</span><span class="p">{</span> <span class="p">.</span><span class="py">nextElementSeed</span> <span class="o">=</span> <span class="n">nextElementSeed</span> <span class="p">},</span>
    <span class="p">);</span>

    <span class="k">fn</span> <span class="n">nextElementSeed</span><span class="p">(</span><span class="n">self</span><span class="p">:</span> <span class="o">*</span><span class="nb">@This</span><span class="p">(),</span> <span class="n">allocator</span><span class="p">:</span> <span class="o">?</span><span class="n">Allocator</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">anytype</span><span class="p">)</span> <span class="n">Deserializer</span><span class="p">.</span><span class="py">Error</span><span class="o">!?</span><span class="nb">@TypeOf</span><span class="p">(</span><span class="n">seed</span><span class="p">).</span><span class="py">Value</span> <span class="p">{</span>
        <span class="c">// ðŸ‘‹ You can ignore the parsing details here. All we're doing is</span>
        <span class="c">//    telling Getty to perform deserialization again (by calling</span>
        <span class="c">//    seed.deserialize) so that we can deserialize an element from</span>
        <span class="c">//    the sequence. If there are no elements left (i.e., if ']' was</span>
        <span class="c">//    encountered) then null is returned. Otherwise, the deserialized</span>
        <span class="c">//    element is returned.</span>
        <span class="k">const</span> <span class="n">element</span> <span class="o">=</span> <span class="n">seed</span><span class="p">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">())</span> <span class="k">catch</span> <span class="p">|</span><span class="n">err</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">.</span><span class="py">len</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">slice</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="py">tokens</span><span class="p">.</span><span class="py">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
                <span class="sc">']'</span> <span class="o">=&gt;</span> <span class="kc">null</span><span class="p">,</span>
                <span class="k">else</span> <span class="o">=&gt;</span> <span class="n">err</span><span class="p">,</span>
            <span class="p">};</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="n">element</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="k">anyerror</span><span class="o">!</span><span class="k">void</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">allocator</span> <span class="o">=</span> <span class="n">std</span><span class="p">.</span><span class="py">heap</span><span class="p">.</span><span class="py">page_allocator</span><span class="p">;</span>

    <span class="c">// ðŸ‘‡</span>
    <span class="k">var</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Deserializer</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="s">"[1,2,3]"</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">deserializer</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="nf">deserializer</span><span class="p">();</span>

    <span class="k">const</span> <span class="n">v</span> <span class="o">=</span> <span class="k">try</span> <span class="n">getty</span><span class="p">.</span><span class="nf">deserialize</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">std</span><span class="p">.</span><span class="nf">ArrayList</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span> <span class="n">deserializer</span><span class="p">);</span>
    <span class="k">defer</span> <span class="n">getty</span><span class="p">.</span><span class="py">de</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

    <span class="n">std</span><span class="p">.</span><span class="py">debug</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"{any} ({})</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">.</span><span class="p">{</span> <span class="n">v</span><span class="p">.</span><span class="py">items</span><span class="p">,</span> <span class="nb">@TypeOf</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

</pre></div>

<div class="code-block"><div class="language-tag">Shell session</div><pre class="code-block-inner">

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>zig build run
<span class="go">{ 1, 2, 3 } (array_list.ArrayListAligned(i32,null))</span></code></pre></figure>

</pre></div>

<p>Hooray!</p>


    </div>

    <!-- SPDX-License-Identifier: LGPL-2.1-or-later -->

<footer class="site-footer">
  <p>&copy; 2022 Getty</p>
</footer>


  </body>

</html>
